model Product {
  id           String                @id @default(uuid())
  tenantId     String
  tenant       Tenant                @relation(fields: [tenantId], references: [id])
  name         String
  description  String?               @db.Text
  sku          String                @unique
  ean          String?
  brand        String?
  unit         String                @default("UN")
  parentId     String?
  parent       Product?              @relation("ProductVariants", fields: [parentId], references: [id])
  variants     Product[]             @relation("ProductVariants")
  variantName  String?
  ncm          String
  cest         String?
  cfop         String?
  origin       Int                   @default(0)
  taxProfileId String?
  taxProfile   TaxProfile?           @relation(fields: [taxProfileId], references: [id])
  costPrice    Decimal               @default(0) @db.Decimal(10, 4)
  expenses     Decimal               @default(0) @db.Decimal(10, 4)
  markup       Decimal               @default(0) @db.Decimal(10, 4)
  prices       ProductPrice[]
  priceHistory ProductPriceHistory[]
  stock        StockItem[]
  images       ProductImage[]
  movements    StockMovement[]
  isActive     Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  OrderItem    OrderItem[]

  @@index([tenantId, sku])
  @@index([tenantId, name])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(uuid())
  url       String
  order     Int      @default(0)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("product_images")
}

model ProductPrice {
  id          String    @id @default(uuid())
  price       Decimal   @db.Decimal(10, 4)
  productId   String
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  priceListId String
  priceList   PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  updatedAt   DateTime  @updatedAt

  @@unique([productId, priceListId])
  @@map("product_prices")
}

model ProductPriceHistory {
  id          String    @id @default(uuid())
  oldPrice    Decimal?  @db.Decimal(10, 4)
  newPrice    Decimal   @db.Decimal(10, 4)
  reason      String?
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  priceListId String
  priceList   PriceList @relation(fields: [priceListId], references: [id])
  changedBy   String?
  user        User?     @relation(fields: [changedBy], references: [id])
  createdAt   DateTime  @default(now())

  @@map("product_price_history")
}

model TaxProfile {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  name        String
  description String?
  products    Product[]
  rules       TaxRule[]

  @@map("tax_profiles")
}

model TaxRule {
  id               String     @id @default(uuid())
  taxProfileId     String
  taxProfile       TaxProfile @relation(fields: [taxProfileId], references: [id], onDelete: Cascade)
  originState      String
  destinationState String
  icmsRate         Decimal    @default(0) @db.Decimal(5, 2)
  ipiRate          Decimal    @default(0) @db.Decimal(5, 2)
  pisRate          Decimal    @default(0) @db.Decimal(5, 2)
  cofinsRate       Decimal    @default(0) @db.Decimal(5, 2)
  updatedAt        DateTime   @updatedAt

  @@unique([taxProfileId, originState, destinationState])
  @@map("tax_rules")
}

model StockItem {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Decimal  @default(0) @db.Decimal(10, 4)
  minStock  Decimal  @default(0) @db.Decimal(10, 4)
  maxStock  Decimal? @db.Decimal(10, 4)
  updatedAt DateTime @updatedAt

  @@map("stock_items")
}
