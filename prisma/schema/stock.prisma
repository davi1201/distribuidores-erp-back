// Adicione ao seu schema existente

enum StockMovementType {
  ENTRY // Entrada (Compra, Produção, Devolução, Ajuste Positivo)
  EXIT // Saída (Venda, Perda, Consumo, Ajuste Negativo)
  TRANSFER // Transferência entre depósitos
}

// Histórico de Movimentações (Kardex)
model StockMovement {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Relacionamento com Produto
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Dados da Movimentação
  type     StockMovementType
  reason   String // Ex: "Venda #123", "Nota Fiscal 555", "Ajuste de Inventário"
  quantity Decimal           @db.Decimal(10, 4) // Quantidade movimentada

  // Snapshots (Valores congelados no momento da operação)
  costPrice    Decimal @default(0) @db.Decimal(10, 4) // Custo unitário no momento
  balanceAfter Decimal @db.Decimal(10, 4) // Saldo resultante após a operação

  // Auditoria
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // NOVOS CAMPOS DE RASTREIO
  fromWarehouseId String?
  fromWarehouse   Warehouse? @relation("MovementFrom", fields: [fromWarehouseId], references: [id])

  toWarehouseId String?
  toWarehouse   Warehouse? @relation("MovementTo", fields: [toWarehouseId], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId, productId])
  @@index([createdAt])
  @@map("stock_movements")
}

model Warehouse {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  name      String // Ex: "Matriz", "Carro do João", "Depósito Secundário"
  isDefault Boolean @default(false) // Se é o estoque principal

  // Vínculo Opcional: Esse depósito pertence a um vendedor específico?
  responsibleUserId String?
  responsibleUser   User?   @relation(fields: [responsibleUserId], references: [id])

  stockItems StockItem[]

  transfersOrigin      StockTransfer[] @relation("TransferOrigin")
  transfersDestination StockTransfer[] @relation("TransferDestination")

  // Rastreabilidade de origem/destino
  movementsFrom StockMovement[] @relation("MovementFrom")
  movementsTo   StockMovement[] @relation("MovementTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("warehouses")
}

enum TransferStatus {
  PENDING // Solicitado pelo vendedor, aguardando Matriz
  APPROVED // Aprovado pela Matriz (Saiu do estoque físico da origem)
  IN_TRANSIT // Em trânsito (Opcional, pode ser usado junto com APPROVED)
  COMPLETED // Recebido pelo vendedor (Entrou no estoque destino)
  REJECTED // Negado
}

model StockTransfer {
  id   String @id @default(uuid())
  code Int    @default(autoincrement()) // Ex: TR-1001

  status TransferStatus @default(PENDING)

  // QUEM PEDIU
  requesterId String
  requester   User   @relation("RequesterUser", fields: [requesterId], references: [id])

  // QUEM APROVOU
  approvedByUserId String?
  approvedBy       User?   @relation("ApproverUser", fields: [approvedByUserId], references: [id])

  // QUEM RECEBEU
  receivedByUserId String?
  receivedBy       User?   @relation("ReceiverUser", fields: [receivedByUserId], references: [id])

  // De onde sai? (Geralmente Matriz)
  originId String
  origin   Warehouse @relation("TransferOrigin", fields: [originId], references: [id])

  // Para onde vai? (Depósito do Vendedor)
  destinationId String
  destination   Warehouse @relation("TransferDestination", fields: [destinationId], references: [id])

  items StockTransferItem[]

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@map("stock_transfers")
}

model StockTransferItem {
  id         String        @id @default(uuid())
  transferId String
  transfer   StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Decimal @db.Decimal(10, 4)

  @@map("stock_transfer_items")
}
